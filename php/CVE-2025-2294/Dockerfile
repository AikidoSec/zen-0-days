FROM debian:bookworm

# Install dependencies
RUN apt update && \
    apt upgrade && \
    apt install -y php php-fpm php-cli php-common php-imap php-xml php-zip php-mbstring php-curl nginx default-mysql-client default-mysql-server curl unzip supervisor php-mysql gettext-base

# Install wordpress
RUN cd /var/www/ && curl -O https://wordpress.org/latest.zip && unzip latest.zip && rm latest.zip
RUN cd /root && curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar && chmod +x wp-cli.phar && mv wp-cli.phar /usr/local/bin/wp

# Disable services
RUN update-rc.d -f nginx disable

# Init database
COPY init-db.sql /tmp/init-db.sql
# Start MySQL daemon directly, wait for it, execute SQL, then shut it down
RUN mysqld_safe --user=mysql & \
    # Wait for mysql server to start (max 30 seconds)
    timeout=30; \
    while ! mysqladmin ping --silent && [ $timeout -gt 0 ]; do \
        sleep 1; \
        timeout=$((timeout-1)); \
    done; \
    # Check if server started
    if ! mysqladmin ping --silent; then \
        echo "MySQL server failed to start." >&2; \
        exit 1; \
    fi; \
    # Execute SQL script
    cat /tmp/init-db.sql | mysql && \
    # Install wordpress
    cd /var/www/wordpress && \
    wp config create --dbname=wordpress --dbuser=wordpress --dbpass=wordpress --allow-root && \
    wp core install --url=localhost:8080 --title="Aikido's safe space" --admin_user=aikido --admin_password=aikido --admin_email=samuel@aikido.dev --allow-root && \
    # Install plugin
    wp plugin install --allow-root --activate https://downloads.wordpress.org/plugin/kubio.2.5.1.zip && \
    # Stop mysql server
    mysqladmin shutdown && \
    rm /tmp/init-db.sql

# Install Zen
RUN curl -L -O https://github.com/AikidoSec/firewall-php/releases/download/v1.0.117/aikido-php-firewall.$(uname -m).deb && dpkg -i -E ./aikido-php-firewall.$(uname -m).deb

# Add config files
ADD etc/ etc/
ENV AIKIDO_TOKEN=""

# Config validation
RUN nginx -t

# Expose ports
EXPOSE 80

# Start supervisor
ADD start.sh /root/start.sh
CMD ["/root/start.sh"]
