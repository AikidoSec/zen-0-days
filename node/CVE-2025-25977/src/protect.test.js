const { test } = require("node:test");
const { equal, throws } = require("node:assert");

test("Protects against Prototype Pollution", async () => {
  const { StyleElement } = require("canvg");
  require("@aikidosec/firewall/nopp");

  equal({}.polluted, undefined);

  const maliciousCSS = `
  __proto__ { polluted: "Yes, polluted!"; }
  `;

  // Creating a mock document object
  const fakeDocument = {
    styles: {},
    stylesSpecificity: {},
    addEventListener: () => {},
    createElement: () => ({ style: {} }),
    appendChild: () => {},
  };

  // Creating a mock node object
  const fakeNode = {
    childNodes: [
      {
        textContent: maliciousCSS,
      },
    ],
  };

  throws(
    () => {
      // Instantiating StyleElement to simulate the attack
      const se = new StyleElement(fakeDocument, fakeNode);
    },
    {
      message: "Cannot add property polluted, object is not extensible",
    }
  );
});
