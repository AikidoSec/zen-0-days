const { test } = require("node:test");
const { equal, throws } = require("node:assert");

test("Protects against Prototype Pollution", async () => {
  const util = require("@firebase/util");
  require("@aikidosec/firewall/nopp");

  equal({}.isPolluted, undefined);

  const payload = JSON.parse('{"__proto__": {"isPolluted": "vulnerable"}}');

  const a = {
    nest: {
      number: 1,
      string: "1",
      object: { key: "1" },
      date: new Date(1),
      nest: {
        a: 1,
      },
    },
  };

  throws(
    () => {
      util.deepExtend(a, payload);
    },
    {
      message: "Cannot add property isPolluted, object is not extensible",
    }
  );

  equal({}.isPolluted, undefined);
});
