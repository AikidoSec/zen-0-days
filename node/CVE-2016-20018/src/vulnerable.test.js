const { test } = require("node:test");
const { equal } = require("node:assert");

test("Vulnerable to SQL Injection", async () => {
  const knex = require("knex")({
    client: "mysql2",
    connection: {
      host: "127.0.0.1",
      user: "root",
      password: "123456",
      database: "test",
      charset: "utf8",
    },
  });

  const exists = await knex.schema.hasTable("users");
  if (!exists) {
    await knex.schema.createTable("users", (table) => {
      table.increments("id").primary();
      table.string("name").notNullable();
      table.string("secret").notNullable();
    });
    await knex("users").insert({
      name: "admin",
      secret: "you should not be able to return this!",
    });
    await knex("users").insert({
      name: "guest",
      secret: "hello world",
    });
  }

  const attackerControlled = {
    name: "admin",
  };

  const users = await knex("users")
    .select()
    .where({ secret: attackerControlled });

  equal(users.length, 2);
  equal(users[0].name, "admin");
  equal(users[0].secret, "you should not be able to return this!");
  equal(users[1].name, "guest");
  equal(users[1].secret, "hello world");
});
