const { test } = require("node:test");
const { equal } = require("node:assert");

test("Vulnerable against SQL injection", async () => {
  const { Hono } = require("hono");
  const { CrudRequestParser } = require("crud-query-parser/parsers/crud");
  const { TypeOrmQueryAdapter } = require("crud-query-parser/adapters/typeorm");

  const AppDataSource = require("./data-source");
  const UserEntity = require("./entities/UserEntity");
  const adapter = new TypeOrmQueryAdapter();

  const app = new Hono();
  const parser = new CrudRequestParser();

  await AppDataSource.initialize();

  const repository = AppDataSource.getRepository(UserEntity);

  app.get("/query", async (c) => {
    try {
      const crudRequest = parser.parse(c.req.query());

      const users = await adapter.getMany(
        repository.createQueryBuilder(),
        crudRequest
      );
      return c.json(users);
    } catch (error) {
      return c.text(error.message, 500);
    }
  });

  const response = await app.request("/query?sort=name; DELETE FROM users; --");

  equal(response.status, 200);
  equal(
    await response.text(),
    JSON.stringify({
      data: [],
      count: 0,
      page: null,
      pageCount: null,
      total: 0,
    })
  );

  await AppDataSource.destroy();
});
